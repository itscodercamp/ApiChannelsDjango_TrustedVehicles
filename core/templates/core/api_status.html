<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Status Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 3rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #60a5fa, #a855f7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .method {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
        }

        .method.GET {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .method.POST {
            background-color: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .endpoint-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .endpoint-url {
            color: var(--text-secondary);
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            word-break: break-all;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
        }

        .status-active .dot {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-error .dot {
            background-color: var(--error);
            box-shadow: 0 0 8px var(--error);
        }

        .status-loading .dot {
            background-color: var(--warning);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .response-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .refresh-btn {
            display: block;
            margin: 2rem auto 0;
            padding: 0.75rem 2rem;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>System Status & Analytics</h1>
            <p class="subtitle">Real-time API Endpoint Monitoring & Usage Stats</p>
        </header>

        <div class="charts-grid">
            <div class="card">
                <h2>Requests per Endpoint</h2>
                <div class="chart-container">
                    <canvas id="endpointChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>Status Code Distribution</h2>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Requests Over Time (24h)</h2>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <h2>Endpoint Status</h2>
        <div class="grid" id="api-grid">
            <!-- Cards will be injected here -->
        </div>

        <button class="refresh-btn" onclick="refreshAll()">Refresh Data</button>
    </div>

    <script>
        // --- Status Logic ---
        const endpoints = [
            { name: 'Employee Login', url: '/api/login', method: 'POST' },
            { name: 'Marketplace Login', url: '/api/marketplace/auth/login', method: 'POST' },
            { name: 'Marketplace Register', url: '/api/marketplace/auth/register', method: 'POST' },
            { name: 'Contact Form', url: '/api/contact', method: 'POST' },
            { name: 'Sell Requests', url: '/api/sell-requests', method: 'POST' },
            { name: 'Loan Requests', url: '/api/loan-requests', method: 'POST' },
            { name: 'Insurance Renewals', url: '/api/insurance-renewals', method: 'POST' },
            { name: 'PDI Inspections', url: '/api/pdi-inspections', method: 'POST' },
            { name: 'Create Inspection', url: '/api/inspections', method: 'POST' },
            { name: 'Website Inspection', url: '/api/customerinspection', method: 'POST' },
            { name: 'Live Vehicles', url: '/api/marketplace/vehicles', method: 'GET' },
            { name: 'Active Banners', url: '/api/marketplace/banners', method: 'GET' },
            { name: 'File Upload', url: '/api/upload', method: 'POST' },
        ];

        const grid = document.getElementById('api-grid');

        function createCard(endpoint, index) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="endpoint-name">${endpoint.name}</span>
                    <span class="method ${endpoint.method}">${endpoint.method}</span>
                </div>
                <div class="endpoint-url">${endpoint.url}</div>
                <div class="status-indicator status-loading" id="status-${index}">
                    <div class="dot"></div>
                    <span class="status-text">Checking...</span>
                    <span class="response-time" id="time-${index}"></span>
                </div>
            `;
            return card;
        }

        async function checkEndpoint(endpoint, index) {
            const startTime = performance.now();
            const statusEl = document.getElementById(`status-${index}`);
            const timeEl = document.getElementById(`time-${index}`);

            try {
                const options = {
                    method: endpoint.method,
                    headers: { 'Content-Type': 'application/json' }
                };

                const response = await fetch(endpoint.url, options);
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                const isActive = response.status !== 404 && response.status !== 502 && response.status !== 503;

                statusEl.className = `status-indicator ${isActive ? 'status-active' : 'status-error'}`;
                statusEl.querySelector('.status-text').textContent = isActive ? `Active (${response.status})` : `Error (${response.status})`;
                timeEl.textContent = `${duration}ms`;

            } catch (error) {
                statusEl.className = 'status-indicator status-error';
                statusEl.querySelector('.status-text').textContent = 'Unreachable';
            }
        }

        function checkAllApis() {
            grid.innerHTML = '';
            endpoints.forEach((endpoint, index) => {
                grid.appendChild(createCard(endpoint, index));
                checkEndpoint(endpoint, index);
            });
        }

        // --- Charts Logic ---
        let endpointChart, statusChart, timelineChart;

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                updateCharts(data);
            } catch (e) {
                console.error("Failed to fetch stats", e);
            }
        }

        function updateCharts(data) {
            // Endpoint Chart
            const ctx1 = document.getElementById('endpointChart').getContext('2d');
            if (endpointChart) endpointChart.destroy();
            endpointChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.endpoints.map(e => e.endpoint),
                    datasets: [{
                        label: 'Requests',
                        data: data.endpoints.map(e => e.count),
                        backgroundColor: '#60a5fa',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            // Status Chart
            const ctx2 = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: data.status_codes.map(s => s.status_code),
                    datasets: [{
                        data: data.status_codes.map(s => s.count),
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                }
            });

            // Timeline Chart
            const ctx3 = document.getElementById('timelineChart').getContext('2d');
            if (timelineChart) timelineChart.destroy();
            timelineChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: data.timeline.map(t => new Date(t.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{
                        label: 'Requests',
                        data: data.timeline.map(t => t.count),
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function refreshAll() {
            checkAllApis();
            fetchStats();
        }

        // Initial Load
        refreshAll();
    </script>
</body>

</html>